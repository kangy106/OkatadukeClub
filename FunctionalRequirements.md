# 機能要求定義書

## **1. 概要**
本システムは、Raspberry Pi（以下、ラズパイ）とサーバを連携させ、ラズパイに接続されたカメラで定期的に写真を撮影し、机の汚さを評価するサービスを提供します。また、異常が検知された場合や判定結果はSlackに通知します。

---

## **2. システム構成**
- **ラズパイ**
  - カメラモジュールを使用して写真を撮影し、サーバにデータを送信します。
  - 正常に写真が撮影できなかった場合はエラーメッセージをサーバに送信します。

- **サーバ**
  - ラズパイから写真データを受信し、AIサービスに画像を送信して机の汚さを判定します。
  - 判定結果やエラーメッセージをSlackに通知します。

- **AIサービス**
  - 受信した画像を基に、机の汚さスコアや異常を判定します。

---

## **3. 機能詳細**

### **3.1 ラズパイ**
#### **3.1.1 写真撮影**
- **タイミング**: 12時間に1回（7時、19時）。
- **異常時の動作**: 写真撮影に失敗した場合、エラーメッセージをサーバに送信。

#### **3.1.2 サーバへの送信**
- **正常時**: 撮影した写真とラズパイの識別子をサーバに送信。
- **異常時**: エラーメッセージを送信。

---

### **3.2 サーバ**
#### **3.2.1 データ受信**
- **対象**: 複数のラズパイからデータを受信。
- **内容**:
  - 写真データ。
  - ラズパイ識別子。
  - エラーメッセージ（必要に応じて）。

#### **3.2.2 AIサービスへの送信**
- **処理**: 受信した写真を外部の生成AIサービスに送信し、机の汚さを判定。

#### **3.2.3 判定結果の処理**
- **正常な写真**:
  - AIサービスから受け取った机の汚さスコアをSlackに通知。
  - **通知内容**:
    - 「机の使用者の名前」
    - 「机の汚さスコア」
    - 「写真URL」

- **異常な写真**:
  - エラー判定（例: 暗い、手が写っているなど）をSlackに通知。
  - **通知内容**:
    - 「机の使用者の名前」
    - 「エラーメッセージ」

---

### **3.3 ラズパイ識別子と机の使用者の紐付け**
#### **データベース**
- サーバ側で以下のようなデータベースを準備し、ラズパイ識別子と机の使用者名を紐付けます。

| ラズパイ識別子 | 使用者名  |
| -------------- | --------- |
| `raspi_001`    | 山田太郎   |
| `raspi_002`    | 佐藤花子   |

- サーバは受信したラズパイ識別子を基にデータベースを参照し、対応する使用者名をSlack通知に利用します。

---

## **4. 通信仕様**
### **4.1 ラズパイ → サーバ**
- **プロトコル**: HTTP POST
- **送信データ**:
  - `photo`: 写真データ
  - `raspi_id`: ラズパイ識別子

### **4.2 サーバ → AIサービス**
- **プロトコル**: HTTP POST
- **送信データ**:
  - `image`: 写真データ
- **応答データ**:
  - `status`: 判定結果（例: clean/messy/error）
  - `score`: 机の汚さスコア（例: 0〜100）
  - `error`: 異常時のエラーメッセージ（例: 暗すぎる、手が写っているなど）

### **4.3 サーバ → Slack**
- **プロトコル**: Slack API
- **送信データ**:
  - `message`: 判定結果（使用者名、スコア、写真URL）またはエラーメッセージ

---

## **5. ログ管理**
### **ラズパイ**
- 撮影成功・失敗ログをローカルに保存。
- **例**:
  - 成功ログ: `[2025-01-24 07:00] 撮影成功: photo_20250124_0700.jpg`
  - 失敗ログ: `[2025-01-24 07:00] 撮影失敗: カメラが接続されていません`

### **サーバ**
- 以下のデータを含むログを保存。
  - **受信**: ラズパイ識別子、写真ファイル名、受信時刻。
  - **判定**: 判定結果、スコア。
  - **Slack通知**: 成功または失敗の詳細。
- **例**:
  - `[2025-01-24 07:01] raspi_001からphoto_20250124_0700.jpgを受信`
  - `[2025-01-24 07:02] 判定結果: messy, score: 85`
  - `[2025-01-24 07:03] Slack通知成功: 山田太郎さんの机が汚れています (score: 85)`

---

## **6. 開発環境**
### **6.1 ラズパイ**
- **OS**: Raspberry Pi OS
- **主要ライブラリ**:
  - Python 3
  - `picamera`（カメラ制御）
  - `requests`（サーバ通信）

### **6.2 サーバ**
- **OS**: 任意（例: Ubuntu 20.04）
- **主要ライブラリ**:
  - Python 3
  - Flask（サーバフレームワーク）
  - `slack_sdk`（Slack通知）

### **6.3 AIサービス**
- **選択肢**:
  - Google Vision API
  - 自作モデル（例: TensorFlow/PyTorch）

---

## **7. 保守・運用**
- **エラー通知**:
  - 写真撮影や判定処理で異常が発生した場合、即座にSlack通知。
- **拡張性**:
  - ラズパイの増設に対応可能。
  - 新たなAI判定機能の追加が容易。